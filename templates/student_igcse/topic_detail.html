{% extends "base.html" %}

{% block title %}{{ topic.title }}{% endblock %}

{% block content %}
<div class="container mx-auto p-6">
    <p class="text-sm mb-4">
        <a href="{% url 'student_igcse:dashboard' %}" class="text-indigo-600 hover:text-indigo-800">Modules</a>
        /
        <a href="{% url 'student_igcse:module_detail' module_slug=module.slug %}" class="text-indigo-600 hover:text-indigo-800">{{ module.title }}</a>
        /
        <span class="text-gray-500 font-semibold">{{ topic.title }}</span>
    </p>

    <h1 class="text-4xl font-extrabold mb-2">{{ topic.title }}</h1>
    <p class="text-gray-600 mb-8">{{ topic.short_description }}</p>

    <hr class="mb-10">

    {% if not access_granted %}
        {# Access Denied Block #}
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative my-6" role="alert">
            <strong class="font-bold">Access Denied!</strong>
            <span class="block sm:inline"> This content requires a subscription or login to view.</span>
            <p class="mt-2"><a href="{{ login_url }}" class="text-red-800 underline font-semibold">Click here to log in or subscribe.</a></p>
        </div>
    {% else %}
        {% for item in content %}
        <div class="mb-12 p-6 border-l-4 rounded-lg shadow-md {% if item.content_type == 'notes' %}border-green-500 bg-white{% else %}border-blue-500 bg-blue-50{% endif %}">
            
            <h2 class="text-2xl font-bold mb-4 text-gray-800">
                {{ item.order }}. {{ item.title }} 
                <span class="text-sm font-normal text-gray-500">({{ item.get_content_type_display }})</span>
            </h2>

            {% if item.content_type == 'interactive' %}
                <div class="interactive-content border border-blue-200 p-4 bg-white">
                    <p class="text-sm text-blue-800 mb-2 font-semibold">Interactive Code Block:</p>
                    {{ item.content_data|safe }}
                </div>
            {% else %} 
                <div class="notes-content text-gray-800 leading-relaxed prose max-w-none">
                    {{ item.content_data|safe }} 
                </div>
            {% endif %}
            
        </div>
        {% endfor %}

        {% if request.user.is_authenticated %}
            <div class="mt-12 p-6 bg-indigo-50 border border-indigo-200 rounded-lg text-center">
                
                {% if topic.user_progress.all|length == 0 or topic.user_progress.all.first.user != request.user %}
                
                    <h3 class="text-2xl font-bold text-indigo-800 mb-4">You're all done!</h3>
                    <p class="text-indigo-700 mb-4">Mark this topic as complete to track your progress in the module dashboard.</p>
                    
                    <form method="post" action="{% url 'student_igcse:complete_topic' module_slug=module.slug topic_slug=topic.slug %}">
                        {% csrf_token %}
                        <button type="submit" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150">
                            Mark Topic Complete
                        </button>
                    </form>
                    
                {% else %}
                    <h3 class="text-2xl font-bold text-green-600 mb-4">âœ… Topic Completed!</h3>
                    <p class="text-green-700 mb-4">You completed this topic on {{ topic.user_progress.all.first.completed_at|date:"M j, Y" }}.</p>
                    <a href="{% url 'student_igcse:module_detail' module_slug=module.slug %}" class="text-indigo-600 hover:text-indigo-800 font-semibold">
                        &larr; Return to Module Overview
                    </a>
                {% endif %}

            </div>
        {% endif %}
        {% endif %}
</div>
{% endblock content %}