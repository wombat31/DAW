{% load static %}

<!DOCTYPE html>
<html>
<head>
Â  Â  <title>DAW - {{ project.title }}</title>
Â  Â  <link rel="stylesheet" href="{% static 'css/daw.css' %}">
Â  Â  <style>
Â  Â  /* Basic timeline and clip styling */
Â  Â  .track { margin: 20px 0; }
Â  Â  .timeline { position: relative; height: 60px; border: 1px solid #ccc; background: #f9f9f9; }
Â  Â  .clip { position: absolute; height: 40px; background: #4CAF50; color: #fff; line-height: 40px; text-align: center; border-radius: 4px; cursor: grab; }
Â  Â Â 
Â  Â  /* === CRITICAL FIX: Ensure clips stack vertically === */
Â  Â  .library-clip {Â 
Â  Â  Â  Â  background: #2196F3;Â 
Â  Â  Â  Â  margin: 5px;
Â  Â  Â  Â  padding: 5px;Â 
Â  Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* THIS LINE FORCES EACH CLIP TO START ON A NEW LINE */
Â  Â  Â  Â  display: block;Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  color: white;Â 
Â  Â  Â  Â  border-radius: 4px;Â 
Â  Â  Â  Â  width: 90%;
Â  Â  }
Â  Â Â 
Â  Â  .grid-line { position: absolute; top:0; bottom:0; width:1px; background:#ccc; }
Â  Â  #playhead { position:absolute; width:2px; background:red; top:0; bottom:0; z-index:1000; }
Â  Â 
Â  Â  </style>
</head>
<body>
Â  Â  <header class="daw-header">
        <div class="header-left">
            <h1 class="project-title">{{ project.title }}</h1>
            <span class="user-info">Logged in as: {{ user.username }}</span>
        </div>

        <div class="header-right">
            <a class="dashboard-link" href="{% url 'dashboard' %}">â®Œ Back to Dashboard</a>
        </div>
    </header>


Â  Â  <div id="controls">
        <button id="play-btn">
            â–¶
            <span>Play</span>
        </button>

        <button id="pause-btn">
            â¸
            <span>Pause</span>
        </button>

        <button id="stop-btn">
            â¹
            <span>Stop</span>
        </button>

        <button id="rewind-btn">
            âª
            <span>Rewind</span>
        </button>

        <button id="forward-btn">
            â©
            <span>Fast Forward</span>
        </button>
    </div>


Â  Â  <div id="daw-container"></div>
    <div class="utility-bar">
        <button id="save-project">ğŸ’¾ Save</button>
        <button id="export-project">â¬‡ Export MP3/WAV</button>
    </div>
Â  Â  <div id="daw-bottom-panels" style="display: flex; gap: 10px; margin-top: 20px;">
        <!-- Available Clips -->
        <div id="clip-library" style="flex: 1; border: 1px solid #ccc; padding: 10px; background:#f8f8f8;">
            <h3>Available Sounds</h3>
        </div>


        <!-- Upload Area -->
        <div id="clip-upload" style="flex: 1; border: 1px solid #ccc; padding: 10px; background:#f8f8f8;">
            <h3>Upload Your MP3</h3>
            <div id="upload-dropzone" style="height: 150px; border: 2px dashed #999; border-radius: 5px; display:flex; align-items:center; justify-content:center; text-align:center; color:#666;">
                Drag and drop MP3 files here
            </div>
            <div id="uploaded-clips-list" style="margin-top:10px;"></div>
        </div>

        <!-- Effects Area -->
        <div id="clip-effects" style="flex: 1; border: 1px solid #ccc; padding: 10px; background:#f8f8f8;">
            <h3>Effects</h3>
            <p>Effects will appear here.</p>
        </div>
    </div>
    <footer class="site-footer">
        Â© Archie and the Wombat 2025
    </footer>

Â  Â  <script>
        // Define the base structure with 4 empty tracks (guaranteed rendering)
        const defaultTracks = [
            { clips: [] },
            { clips: [] },
            { clips: [] },
            { clips: [] }
        ];

        let initialProjectData = {
            id: {{ project.pk|default:'null' }},
            tracks: defaultTracks
        };

        // project_json is now guaranteed to be a valid JSON string from the backend (views.py)
        const rawJsonString = '{{ project_json|safe }}';

        try {
            const parsedData = JSON.parse(rawJsonString);

            // Merge the clips from the parsed data onto our guaranteed 4-track structure.
            if (parsedData.tracks && Array.isArray(parsedData.tracks)) {
                parsedData.tracks.forEach((loadedTrack, index) => {
                    if (initialProjectData.tracks[index] && loadedTrack.clips) {
                        initialProjectData.tracks[index].clips = loadedTrack.clips;
                    }
                });
            }

        } catch (e) {
            console.error("Failed to parse project_json. Using default 4-track structure.", e);
        }

        window.PROJECT_DATA = initialProjectData;
        console.log("PROJECT_DATA injected:", window.PROJECT_DATA);
    </script>
Â  Â  <script src="{% static 'js/daw.js' %}"></script>
</body>
</html>