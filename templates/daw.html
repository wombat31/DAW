{% load static %}

<!DOCTYPE html>
<html>
<head>
    <title>DAW - {{ project.title }}</title>
    <link rel="stylesheet" href="{% static 'css/daw.css' %}">
    <style>
    /* Basic timeline and clip styling */
    .track { margin: 20px 0; }
    .timeline { position: relative; height: 60px; border: 1px solid #ccc; background: #f9f9f9; }
    .clip { position: absolute; height: 40px; background: #4CAF50; color: #fff; line-height: 40px; text-align: center; border-radius: 4px; cursor: grab; }
    
    /* === CRITICAL FIX: Ensure clips stack vertically === */
    .library-clip { 
        background: #2196F3; 
        margin: 5px;
        padding: 5px; 
        cursor: pointer; 
        
        /* THIS LINE FORCES EACH CLIP TO START ON A NEW LINE */
        display: block; 
        
        color: white; 
        border-radius: 4px; 
        width: 90%;
    }
    
    .grid-line { position: absolute; top:0; bottom:0; width:1px; background:#ccc; }
    #playhead { position:absolute; width:2px; background:red; top:0; bottom:0; z-index:1000; }
    #controls { margin: 10px 0; }
    </style>
</head>
<body>
    <h1>{{ project.title }}</h1>
    <p>Logged in as: {{ user.username }}</p>
    <a href="{% url 'dashboard' %}">Back to Dashboard</a>
    <hr>

    <div id="controls">
        <button id="play-btn">Play</button>
        <button id="pause-btn">Pause</button>
        <button id="stop-btn">Stop</button>
        <button id="rewind-btn">Rewind</button>
        <button id="forward-btn">Fast Forward</button>
    </div>

    <div id="daw-container"></div>

    <button id="save-project">Save</button>
    <button id="export-project">Export MP3/WAV</button>

    <div id="daw-bottom-panels" style="display: flex; gap: 10px; margin-top: 20px;">
        <!-- Available Clips -->
        <div id="clip-library" style="flex: 1; border: 1px solid #ccc; padding: 10px; background:#f8f8f8;">
            <h3>Available Sounds</h3>
        </div>


        <!-- Upload Area -->
        <div id="clip-upload" style="flex: 1; border: 1px solid #ccc; padding: 10px; background:#f8f8f8;">
            <h3>Upload Your MP3</h3>
            <div id="upload-dropzone" style="height: 150px; border: 2px dashed #999; border-radius: 5px; display:flex; align-items:center; justify-content:center; text-align:center; color:#666;">
                Drag and drop MP3 files here
            </div>
            <div id="uploaded-clips-list" style="margin-top:10px;"></div>
        </div>

        <!-- Effects Area -->
        <div id="clip-effects" style="flex: 1; border: 1px solid #ccc; padding: 10px; background:#f8f8f8;">
            <h3>Effects</h3>
            <p>Effects will appear here.</p>
        </div>
    </div>

    <script>
        // Define the base structure with 4 empty tracks (guaranteed rendering)
        const defaultTracks = [
            { clips: [] },
            { clips: [] },
            { clips: [] },
            { clips: [] }
        ];

        let initialProjectData = {
            id: {{ project.pk|default:'null' }},
            tracks: defaultTracks
        };

        // project_json is now guaranteed to be a valid JSON string from the backend (views.py)
        const rawJsonString = '{{ project_json|safe }}';

        try {
            const parsedData = JSON.parse(rawJsonString);

            // Merge the clips from the parsed data onto our guaranteed 4-track structure.
            if (parsedData.tracks && Array.isArray(parsedData.tracks)) {
                parsedData.tracks.forEach((loadedTrack, index) => {
                    if (initialProjectData.tracks[index] && loadedTrack.clips) {
                        initialProjectData.tracks[index].clips = loadedTrack.clips;
                    }
                });
            }

        } catch (e) {
            console.error("Failed to parse project_json. Using default 4-track structure.", e);
        }

        window.PROJECT_DATA = initialProjectData;
        console.log("PROJECT_DATA injected:", window.PROJECT_DATA);
    </script>
    <script src="{% static 'js/daw.js' %}"></script>
</body>
</html>